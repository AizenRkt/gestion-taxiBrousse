<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Billets</title>

    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{/template/assets/compiled/svg/favicon.svg}" type="image/x-icon">

    <!-- CSS Mazer -->
    <link rel="stylesheet" th:href="@{/template/assets/compiled/css/app.css}">
    <link rel="stylesheet" th:href="@{/template/assets/compiled/css/app-dark.css}">
</head>

<body>
    <script th:src="@{/template/assets/static/js/initTheme.js}"></script>
<div id="app">

  <!-- Sidebar dynamique -->
        <div th:replace="fragments/sidebar :: sidebar"></div>


    <div id="main" class="layout-horizontal">

        <!-- ===== Header ===== -->
        <header class="mb-3">
            <div class="header-top">
                <div class="container">
                    <div class="logo">
                        <h4>ðŸŽ« Gestion des Billets</h4>
                    </div>
                </div>
            </div>
        </header>

        <!-- ===== Main Content ===== -->
        <div class="content-wrapper container">

            <!-- ===== Titre ===== -->
            <div class="page-heading">
                <h3>Liste des billets</h3>
            </div>

            <div class="page-content">

                <!-- ===== Formulaire de recherche ===== -->
                <section class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Rechercher un trajet</h4>
                            </div>
                            <div class="card-body">
                            <form id="search-form">
    <div class="row">
        <div class="col-md-3">
            <label>DÃ©part</label>
            <select class="form-select" name="depart">
                <option value="">-- Choisir --</option>
            </select>
        </div>

        <div class="col-md-3">
            <label>ArrivÃ©e</label>
            <select class="form-select" name="arrivee">
                <option value="">-- Choisir --</option>
            </select>
        </div>

        <div class="col-md-3">
            <label>Date de dÃ©part</label>
            <input type="datetime-local" class="form-control" name="date">
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" type="submit">Rechercher</button>
        </div>
    </div>
</form>

<!-- Tableau rÃ©sultats -->
<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>DÃ©part</th>
            <th>ArrivÃ©e</th>
            <th>Date & Heure</th>
            <th>Voiture</th>
            <th>Prix</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="voyages-table-body"></tbody>
</table>

<script>
let trajets = [];

document.addEventListener("DOMContentLoaded", () => {
    loadTrajets();
    loadVoyages();

    const form = document.getElementById("search-form");
    form.addEventListener("submit", e => {
        e.preventDefault();
        rechercherVoyages();
    });
});

// Charger les dÃ©parts / arrivÃ©es dynamiquement
function loadTrajets() {
    fetch("/api/trajets/depart-arrivee")
        .then(res => res.json())
        .then(data => {
            trajets = data;
            populateDepartOptions();
        })
        .catch(err => console.error(err));
}

function populateDepartOptions() {
    const departSelect = document.querySelector("select[name='depart']");
    departSelect.innerHTML = '<option value="">-- Choisir --</option>';
    const departs = [...new Set(trajets.map(t => t.depart))];
    departs.forEach(d => {
        const option = document.createElement("option");
        option.value = d;
        option.textContent = d;
        departSelect.appendChild(option);
    });

    departSelect.addEventListener("change", populateArriveeOptions);
}

function populateArriveeOptions() {
    const departSelect = document.querySelector("select[name='depart']");
    const arriveeSelect = document.querySelector("select[name='arrivee']");
    const selectedDepart = departSelect.value;

    arriveeSelect.innerHTML = '<option value="">-- Choisir --</option>';
    if (!selectedDepart) return;

    const arrivees = trajets.filter(t => t.depart === selectedDepart)
                            .map(t => t.arrivee);
    [...new Set(arrivees)].forEach(a => {
        const option = document.createElement("option");
        option.value = a;
        option.textContent = a;
        arriveeSelect.appendChild(option);
    });
}

// Recherche voyages selon le TrajetDTO
function rechercherVoyages() {
    const depart = document.querySelector("select[name='depart']").value;
    const arrivee = document.querySelector("select[name='arrivee']").value;
    const date = document.querySelector("input[name='date']").value;
    let url = `/api/voyages/voyagesDisponibles?depart=${encodeURIComponent(depart)}&arrivee=${encodeURIComponent(arrivee)}&date=${encodeURIComponent(date)}`;
    fetch(url)
        .then(res => {
            if (!res.ok) return [];
            return res.json();
        })
        .then(voyages => {
            // SÃ©curiser si l'API renvoie un objet
            if (!Array.isArray(voyages)) voyages = Object.values(voyages);
            afficherResultats(voyages);
        })
        .catch(err => console.error(err));
}

function afficherResultats(voyages) {
    const tbody = document.getElementById("voyages-table-body");
    tbody.innerHTML = "";

    if (!Array.isArray(voyages) || voyages.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">Aucun voyage trouvÃ©</td></tr>';
        return;
    }

    voyages.forEach(v => {
        const dateDepart = new Date(v.dateDepart).toLocaleString("fr-FR", { 
            dateStyle: "short", timeStyle: "short" 
        });
        const dateArrivee = new Date(v.dateArrivee).toLocaleString("fr-FR", { 
            dateStyle: "short", timeStyle: "short" 
        });

        // S'assurer que prix existe
        const prix = (v.prix != null) ? Number(v.prix).toFixed(2) : "â€”";

        const row = `
            <tr>
                <td>${v.depart}</td>
                <td>${v.arrivee}</td>
                <td>${dateDepart} â†’ ${dateArrivee}</td>
                <td>${v.vehicule ?? "â€”"}</td>
                <td>${prix}</td>
                <td>
                    <button class="btn btn-success btn-sm" onclick="acheterBillet(${v.idVoyage})">
                        Acheter
                    </button>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
    });
}
function loadVoyages() {
    fetch("/api/voyages")  // Sans filtre â†’ tous les voyages
        .then(res => res.json())
        .then(data => afficherResultats(data))
        .catch(err => console.error(err));
}

function acheterBillet(idVoyage) {
  window.location.href = `/reservations/confirmationAchat?voyageId=${idVoyage}`;
}
</script>



</body>
</html>
